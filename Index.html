<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TheBikerZone | Social Feed</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-storage-compat.js"></script>
</head>
<body class="bg-gray-50">
<div id="root"></div>

<script type="text/javascript">
const { useState, useEffect } = React;

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBmbEztflh7PrcHKggM2-lzoMhzNkOup5o",
  authDomain: "thebikerzone-54094.firebaseapp.com",
  projectId: "thebikerzone-54094",
  storageBucket: "thebikerzone-54094.firebasestorage.app",
  messagingSenderId: "654294837831",
  appId: "1:654294837831:web:1c73e7707de9a2fd4a5f62"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const storage = firebase.storage();
const provider = new firebase.auth.GoogleAuthProvider();

function App() {
  const [user, setUser] = useState(null);
  const [posts, setPosts] = useState([]);
  const [newPost, setNewPost] = useState({ content:"", images:[], videos:[], productLinks:[], tags:"" });
  const [loading, setLoading] = useState(true);
  const [carouselIndex, setCarouselIndex] = useState({});
  const [linkPreview, setLinkPreview] = useState(null);

  useEffect(() => {
    const unsubAuth = auth.onAuthStateChanged(u => setUser(u));
    loadPosts();
    return () => unsubAuth();
  }, []);

  async function loadPosts() {
    setLoading(true);
    const snapshot = await db.collection("posts").orderBy("created_at","desc").get();
    const data = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
    setPosts(data);
    setLoading(false);
  }

  async function uploadFile(file, folder){
    const ref = storage.ref().child(`${folder}/${Date.now()}_${file.name}`);
    await ref.put(file);
    return await ref.getDownloadURL();
  }

  async function addPost(e){
    e.preventDefault();
    if(!user) return alert("Accedi con Google per postare!");

    const imagesUrls = [];
    const videosUrls = [];
    for(const img of newPost.images){ imagesUrls.push(await uploadFile(img,"images")); }
    for(const vid of newPost.videos){ videosUrls.push(await uploadFile(vid,"videos")); }

    await db.collection("posts").add({
      content: newPost.content,
      username: user.displayName,
      likes:0,
      created_at:new Date(),
      images: imagesUrls,
      videos: videosUrls,
      productLinks: newPost.productLinks.filter(l=>l.trim()!==""),
      tags: newPost.tags.split(",").map(t=>t.trim()).filter(Boolean)
    });

    setNewPost({ content:"", images:[], videos:[], productLinks:[], tags:"" });
    setLinkPreview(null);
    loadPosts();
  }

  async function addLike(id){
    if(!user) return alert("Accedi per mettere mi piace!");
    const ref = db.collection("posts").doc(id);
    await db.runTransaction(async tx=>{
      const doc = await tx.get(ref);
      if(!doc.exists) return;
      tx.update(ref,{likes:(doc.data().likes||0)+1});
    });
    loadPosts();
  }

  function handleFileChange(e,type){
    const files = Array.from(e.target.files);
    if(type==="image") setNewPost({...newPost, images:files});
    if(type==="video") setNewPost({...newPost, videos:files});
  }

  function prevCarousel(postId,length){
    setCarouselIndex({...carouselIndex,[postId]:(carouselIndex[postId]||0)-1<0?length-1:(carouselIndex[postId]||0)-1});
  }

  function nextCarousel(postId,length){
    setCarouselIndex({...carouselIndex,[postId]:(carouselIndex[postId]||0)+1>=length?0:(carouselIndex[postId]||0)+1});
  }

  async function fetchLinkPreview(url){
    if(!url){ setLinkPreview(null); return; }
    try{
      const response = await fetch(`https://api.opengraph.io/api/1.1/site/${encodeURIComponent(url)}?app_id=YOUR_APP_ID`);
      const data = await response.json();
      if(data && data.hybridGraph){
        setLinkPreview({
          title: data.hybridGraph.title,
          description: data.hybridGraph.description,
          image: data.hybridGraph.image
        });
      } else { setLinkPreview(null); }
    } catch(e){ setLinkPreview(null); }
  }

  return React.createElement("div",{className:"max-w-3xl mx-auto py-6"},
    React.createElement("header",{className:"flex justify-between items-center mb-6"},
      React.createElement("h1",{className:"text-3xl font-bold text-orange-600"},"ðŸï¸ TheBikerZone"),
      user?
      React.createElement("div",{className:"flex items-center gap-3"},
        React.createElement("span",null,"ðŸ‘‹ ",user.displayName),
        React.createElement("button",{onClick:()=>auth.signOut(), className:"px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"},"Logout")
      ):
      React.createElement("button",{onClick:()=>auth.signInWithPopup(provider), className:"px-3 py-1 bg-orange-600 text-white rounded hover:bg-orange-700"},"Accedi con Google")
    ),

    user && React.createElement("form",{onSubmit:addPost,className:"bg-white p-4 rounded shadow mb-6 flex flex-col gap-3"},
      React.createElement("textarea",{className:"w-full border p-2 rounded",value:newPost.content,onChange:e=>setNewPost({...newPost, content:e.target.value}),placeholder:"Scrivi qualcosa...", required:true}),
      React.createElement("input",{type:"file", accept:"image/*", multiple:true, onChange:e=>handleFileChange(e,"image")}),
      React.createElement("input",{type:"file", accept:"video/*", multiple:true, onChange:e=>handleFileChange(e,"video")}),
      React.createElement("input",{type:"text", placeholder:"Link prodotti separati da virgola", className:"border p-2 rounded", value:newPost.productLinks.join(","), onChange:e=>{
        const links = e.target.value.split(",");
        setNewPost({...newPost, productLinks: links});
        fetchLinkPreview(links[links.length-1].trim());
      }}),
      linkPreview && React.createElement("div",{className:"mt-2 p-3 border rounded bg-gray-50"},
        React.createElement("h3",{className:"font-semibold"},linkPreview.title),
        React.createElement("p",{className:"text-sm"},linkPreview.description),
        linkPreview.image && React.createElement("img",{src:linkPreview.image, alt:linkPreview.title, className:"w-full h-auto mt-2 rounded"})
      ),
      React.createElement("input",{type:"text", placeholder:"Tag separati da virgola", className:"border p-2 rounded", value:newPost.tags, onChange:e=>setNewPost({...newPost, tags:e.target.value})}),
      newPost.images.length>0 && React.createElement("div",{className:"flex gap-2 overflow-x-auto my-2"}, newPost.images.map((img,i)=>React.createElement("img",{key:i,src:URL.createObjectURL(img),className:"h-24 rounded object-cover"}))),
      newPost.videos.length>0 && React.createElement("div",{className:"flex gap-2 overflow-x-auto my-2"}, newPost.videos.map((vid,i)=>React.createElement("video",{key:i,src:URL.createObjectURL(vid),controls:true,className:"h-24 rounded"}))),
      React.createElement("button",{className:"bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700"},"Pubblica")
    ),

    loading?React.createElement("p",{className:"text-center"},"â³ Caricamento...") :
    posts.map(post=>React.createElement("div",{key:post.id,className:"bg-white p-4 rounded shadow mb-6"},
      React.createElement("p",{className:"text-gray-800"},post.content),
      (post.images.length>0 || post.videos.length>0) && React.createElement("div",{className:"relative mt-2"},
        post.images.concat(post.videos).map((url,i)=>{
          const idx = carouselIndex[post.id]||0;
          if(i!==idx) return null;
          if(i<post.images.length) return React.createElement("img",{key:i,src:url,className:"w-full max-h-64 object-cover rounded"});
          else return React.createElement("video",{key:i,src:url,controls:true,className:"w-full max-h-64 rounded"});
        }),
        React.createElement("button",{onClick:()=>prevCarousel(post.id,post.images.concat(post.videos).length), className:"absolute top-1/2 left-2 bg-black bg-opacity-30 text-white px-2 py-1 rounded"},"â€¹"),
        React.createElement("button",{onClick()=>nextCarousel(post.id,post.images.concat(post.videos).length), className:"absolute top-1/2 right-2 bg-black bg-opacity-30 text-white px-2 py-1 rounded"},"â€º")
      ),
      post.productLinks && post.productLinks.map((link,i)=>link.trim()!=="" && React.createElement("a",{key:i,href:link,target:"_blank", rel:"noopener noreferrer", className:"text-blue-600 hover:underline inline-block mt-1 mr-2"},"ðŸ”— Prodotto ",i+1)),
      post.tags && post.tags.length>0 && React.createElement("div",{className:"mt-2 flex gap
