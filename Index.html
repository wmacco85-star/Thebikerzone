<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TheBikerZone | Community per motociclisti</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React e ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>

    <link
      rel="icon"
      href="https://cdn-icons-png.flaticon.com/512/1085/1085783.png"
    />
  </head>

  <body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/javascript">
      const { useState, useEffect } = React;

      // ðŸ”¥ CONFIGURAZIONE FIREBASE INTEGRATA
      const firebaseConfig = {
        apiKey: "AIzaSyBmbEztflh7PrcHKggM2-lzoMhzNkOup5o",
        authDomain: "thebikerzone-54094.firebaseapp.com",
        projectId: "thebikerzone-54094",
        storageBucket: "thebikerzone-54094.firebasestorage.app",
        messagingSenderId: "654294837831",
        appId: "1:654294837831:web:1c73e7707de9a2fd4a5f62"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();
      const provider = new firebase.auth.GoogleAuthProvider();

      function App() {
        const [user, setUser] = useState(null);
        const [posts, setPosts] = useState([]);
        const [loading, setLoading] = useState(true);
        const [newPost, setNewPost] = useState({
          title: "",
          content: "",
          type: "tip",
        });
        const [commentInputs, setCommentInputs] = useState({});

        // ðŸ”„ Ascolta login/logout in tempo reale
        useEffect(() => {
          const unsubscribe = auth.onAuthStateChanged((u) => setUser(u));
          loadPosts();
          return () => unsubscribe();
        }, []);

        async function loadPosts() {
          setLoading(true);
          try {
            const snapshot = await db
              .collection("posts")
              .orderBy("created_at", "desc")
              .get();
            const data = await Promise.all(
              snapshot.docs.map(async (doc) => {
                const postData = { id: doc.id, ...doc.data() };
                const commentsSnap = await db
                  .collection("posts")
                  .doc(doc.id)
                  .collection("comments")
                  .orderBy("created_at", "asc")
                  .get();
                postData.comments = commentsSnap.docs.map((c) => c.data());
                return postData;
              })
            );
            setPosts(data);
          } catch (err) {
            console.error("Errore caricamento post:", err);
          }
          setLoading(false);
        }

        async function addPost(e) {
          e.preventDefault();
          if (!user) return alert("Effettua il login per postare!");
          await db.collection("posts").add({
            ...newPost,
            username: user.displayName,
            userId: user.uid,
            likes: 0,
            created_at: new Date(),
          });
          setNewPost({ title: "", content: "", type: "tip" });
          loadPosts();
        }

        async function addLike(id) {
          if (!user) return alert("Effettua il login per mettere Mi Piace!");
          const postRef = db.collection("posts").doc(id);
          await db.runTransaction(async (tx) => {
            const doc = await tx.get(postRef);
            if (!doc.exists) return;
            const newLikes = (doc.data().likes || 0) + 1;
            tx.update(postRef, { likes: newLikes });
          });
          loadPosts();
        }

        async function addComment(postId) {
          if (!user) return alert("Effettua il login per commentare!");
          const text = commentInputs[postId];
          if (!text || text.trim() === "") return;
          await db
            .collection("posts")
            .doc(postId)
            .collection("comments")
            .add({
              text,
              username: user.displayName,
              userId: user.uid,
              created_at: new Date(),
            });
          setCommentInputs({ ...commentInputs, [postId]: "" });
          loadPosts();
        }

        async function loginGoogle() {
          try {
            await auth.signInWithPopup(provider);
          } catch (err) {
            console.error("Errore login:", err);
          }
        }

        async function logout() {
          await auth.signOut();
        }

        return React.createElement(
          "div",
          { className: "min-h-screen flex flex-col" },

          // HEADER
          React.createElement(
            "header",
            {
              className:
                "bg-white shadow p-4 flex justify-between items-center",
            },
            React.createElement(
              "h1",
              { className: "text-2xl font-bold text-orange-600" },
              "ðŸï¸ TheBikerZone"
            ),
            user
              ? React.createElement(
                  "div",
                  { className: "flex items-center space-x-3" },
                  React.createElement(
                    "span",
                    { className: "text-gray-700" },
                    "ðŸ‘‹ ",
                    user.displayName
                  ),
                  React.createElement(
                    "button",
                    {
                      onClick: logout,
                      className:
                        "border border-gray-300 px-3 py-1 rounded hover:bg-gray-100",
                    },
                    "Logout"
                  )
                )
              : React.createElement(
                  "button",
                  {
                    className:
                      "bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded",
                    onClick: loginGoogle,
                  },
                  "ðŸš€ Accedi con Google"
                )
          ),

          // FORM POST
          user &&
            React.createElement(
              "form",
              {
                onSubmit: addPost,
                className:
                  "bg-white p-4 m-4 rounded shadow flex flex-col gap-3",
              },
              React.createElement("input", {
                type: "text",
                placeholder: "Titolo del post",
                value: newPost.title,
                onChange: (e) =>
                  setNewPost({ ...newPost, title: e.target.value }),
                className: "border p-2 rounded",
                required: true,
              }),
              React.createElement("textarea", {
                placeholder: "Scrivi la tua esperienza...",
                value: newPost.content,
                onChange: (e) =>
                  setNewPost({ ...newPost, content: e.target.value }),
                className: "border p-2 rounded",
                required: true,
              }),
              React.createElement(
                "button",
                {
                  type: "submit",
                  className:
                    "bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded",
                },
                "ðŸ Pubblica"
              )
            ),

          // LISTA POST
          React.createElement(
            "main",
            { className: "flex-1 container mx-auto p-4" },
            loading
              ? React.createElement(
                  "p",
                  { className: "text-center" },
                  "â³ Caricamento post..."
                )
              : posts.length === 0
              ? React.createElement(
                  "p",
                  { className: "text-center text-gray-500" },
                  "Nessun post ancora! âœ¨"
                )
              : posts.map((post) =>
                  React.createElement(
                    "div",
                    {
                      key: post.id,
                      className:
                        "bg-white rounded shadow p-4 mb-4 transition hover:shadow-lg",
                    },
                    React.createElement(
                      "h2",
                      { className: "text-xl font-semibold" },
                      post.title
                    ),
                    React.createElement(
                      "p",
                      { className: "text-gray-700 my-2" },
                      post.content
                    ),
                    React.createElement(
                      "div",
                      { className: "flex justify-between items-center mt-3" },
                      React.createElement(
                        "span",
                        { className: "text-sm text-gray-500" },
                        "âœï¸ ",
                        post.username || "Anonimo",
                        " â€¢ ",
                        new Date(
                          post.created_at?.seconds * 1000 || post.created_at
                        ).toLocaleDateString()
                      ),
                      React.createElement(
                        "button",
                        {
                          onClick: () => addLike(post.id),
                          className:
                            "flex items-center space-x-1 text-red-500 hover:scale-110 transition",
                        },
                        React.createElement("span", null, "â¤ï¸"),
                        React.createElement(
                          "span",
                          { className: "text-sm font-medium" },
                          post.likes || 0
                        )
                      )
                    ),
                    // COMMENTI
                    React.createElement(
                      "div",
                      { className: "mt-3 border-t pt-3" },
                      post.comments.map((c, idx) =>
                        React.createElement(
                          "div",
                          { key: idx, className: "text-sm mb-1" },
                          React.createElement(
                            "span",
                            { className: "font-medium" },
                            c.username
                          ),
                          ": ",
                          c.text
                        )
                      ),
                      user &&
                        React.createElement(
                          "div",
                          { className: "flex mt-2 gap-2" },
                          React.createElement("input", {
                            type: "text",
                            placeholder: "Scrivi un commento...",
                            value: commentInputs[post.id] || "",
                            onChange: (e) =>
                              setCommentInputs({
                                ...commentInputs,
                                [post.id]: e.target.value,
                              }),
                            className: "border p-2 flex-1 rounded",
                          }),
                          React.createElement(
                            "button",
                            {
                              onClick: () =>
