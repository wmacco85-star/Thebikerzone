<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TheBikerZone | Social Feed</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-storage-compat.js"></script>
</head>
<body class="bg-gray-50">
<div id="root"></div>

<script>
const { useState, useEffect } = React;

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBmbEztflh7PrcHKggM2-lzoMhzNkOup5o",
  authDomain: "thebikerzone-54094.firebaseapp.com",
  projectId: "thebikerzone-54094",
  storageBucket: "thebikerzone-54094.firebasestorage.app",
  messagingSenderId: "654294837831",
  appId: "1:654294837831:web:1c73e7707de9a2fd4a5f62"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const storage = firebase.storage();
const provider = new firebase.auth.GoogleAuthProvider();

function App() {
  const [user, setUser] = useState(null);
  const [posts, setPosts] = useState([]);
  const [newPost, setNewPost] = useState({content:"", images:[], videos:[], productLinks:[], tags:""});
  const [loading, setLoading] = useState(true);
  const [linkPreview, setLinkPreview] = useState({});
  const [carouselIndex, setCarouselIndex] = useState({});

  useEffect(() => {
    const unsubAuth = auth.onAuthStateChanged(u => setUser(u));
    loadPosts();
    return () => unsubAuth();
  }, []);

  function loadPosts() {
    db.collection("posts").orderBy("created_at","desc").get()
      .then(snapshot => {
        const data = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        setPosts(data);
        setLoading(false);
      }).catch(console.error);
  }

  async function uploadFile(file, folder){
    const ref = storage.ref().child(`${folder}/${Date.now()}_${file.name}`);
    await ref.put(file);
    return await ref.getDownloadURL();
  }

  async function addPost(e){
    e.preventDefault();
    if(!user) return alert("Accedi con Google per postare!");

    const imagesUrls = [];
    const videosUrls = [];
    for(const img of newPost.images){ imagesUrls.push(await uploadFile(img,"images")); }
    for(const vid of newPost.videos){ videosUrls.push(await uploadFile(vid,"videos")); }

    await db.collection("posts").add({
      content: newPost.content,
      images: imagesUrls,
      videos: videosUrls,
      username: user.displayName,
      likes:0,
      created_at:new Date(),
      productLinks: newPost.productLinks.filter(l=>l.trim()!==""),
      tags: newPost.tags.split(",").map(t=>t.trim()).filter(Boolean)
    });

    setNewPost({content:"", images:[], videos:[], productLinks:[], tags:""});
    setLinkPreview({});
    loadPosts();
  }

  function handleFileChange(e,type){
    const files = Array.from(e.target.files);
    if(type==="image") setNewPost({...newPost, images:files});
    if(type==="video") setNewPost({...newPost, videos:files});
  }

  async function fetchLinkPreview(url,i){
    if(!url){ setLinkPreview({...linkPreview,[i]:null}); return; }
    try{
      const response = await fetch(`https://api.opengraph.io/api/1.1/site/${encodeURIComponent(url)}?app_id=YOUR_APP_ID`);
      const data = await response.json();
      if(data && data.hybridGraph){
        setLinkPreview({...linkPreview,[i]:{
          title: data.hybridGraph.title,
          description: data.hybridGraph.description,
          image: data.hybridGraph.image
        }});
      } else setLinkPreview({...linkPreview,[i]:null});
    } catch(e){ setLinkPreview({...linkPreview,[i]:null}); }
  }

  function addLike(postId){
    if(!user) return alert("Accedi per mettere mi piace!");
    const ref = db.collection("posts").doc(postId);
    db.runTransaction(tx => {
      return tx.get(ref).then(doc=>{
        if(!doc.exists) return;
        tx.update(ref,{likes:(doc.data().likes||0)+1});
      });
    }).then(loadPosts).catch(console.error);
  }

  function prevCarousel(postId,length){
    setCarouselIndex({...carouselIndex,[postId]:(carouselIndex[postId]||0)-1<0?length-1:(carouselIndex[postId]||0)-1});
  }

  function nextCarousel(postId,length){
    setCarouselIndex({...carouselIndex,[postId]:(carouselIndex[postId]||0)+1>=length?0:(carouselIndex[postId]||0)+1});
  }

  return React.createElement("div",{className:"max-w-3xl mx-auto py-6"},
    React.createElement("header",{className:"flex justify-between items-center mb-6"},
      React.createElement("h1",{className:"text-3xl font-bold text-orange-600"},"ðŸï¸ TheBikerZone"),
      user?
      React.createElement("div",{className:"flex items-center gap-3"},
        React.createElement("span",null,"ðŸ‘‹ ",user.displayName),
        React.createElement("button",{onClick:()=>auth.signOut(), className:"px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"},"Logout")
      ):
      React.createElement("button",{onClick:()=>auth.signInWithPopup(provider), className:"px-3 py-1 bg-orange-600 text-white rounded hover:bg-orange-700"},"Accedi con Google")
    ),

    user && React.createElement("form",{onSubmit:addPost,className:"bg-white p-4 rounded shadow mb-6 flex flex-col gap-3"},
      React.createElement("textarea",{className:"w-full border p-2 rounded",value:newPost.content,onChange:e=>setNewPost({...newPost, content:e.target.value}),placeholder:"Scrivi qualcosa...", required:true}),
      React.createElement("input",{type:"file", accept:"image/*", multiple:true, onChange:e=>handleFileChange(e,"image")}),
      React.createElement("input",{type:"file", accept:"video/*", multiple:true, onChange:e=>handleFileChange(e,"video")}),
      newPost.productLinks.map((link,i)=>React.createElement("div",{key:i,className:"flex flex-col gap-1"},
        React.createElement("input",{type:"text", placeholder:"Link prodotto", className:"border p-2 rounded", value:newPost.productLinks[i], onChange:e=>{
          const links=[...newPost.productLinks]; links[i]=e.target.value; setNewPost({...newPost, productLinks:links});
          fetchLinkPreview(e.target.value,i);
        }}),
        linkPreview[i] && React.createElement("div",{className:"p-2 border rounded bg-gray-50"},
          React.createElement("h3",{className:"font-semibold"},linkPreview[i].title),
          React.createElement("p",{className:"text-sm"},linkPreview[i].description),
          linkPreview[i].image && React.createElement("img",{src:linkPreview[i].image,className:"w-full rounded mt-1"})
        )
      )),
      React.createElement("button",{type:"button", onClick:()=>setNewPost({...newPost, productLinks:[...newPost.productLinks,""]}), className:"bg-gray-200 px-3 py-1 rounded"},"Aggiungi link"),
      React.createElement("input",{type:"text", placeholder:"Tag separati da virgola", className:"border p-2 rounded", value:newPost.tags, onChange:e=>setNewPost({...newPost, tags:e.target.value})}),
      React.createElement("button",{className:"bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700"},"Pubblica")
    ),

    loading?React.createElement("p",{className:"text-center"},"â³ Caricamento...") :
    posts.map(post=>{
      const media = (post.images||[]).concat(post.videos||[]);
      const idx = carouselIndex[post.id]||0;
